Для удобства я комментил всё что пишу здесь прямо в коде, так что если будет интересно сразу смотреть воплощение - можно открыть код, там в комментариях то же самое. Чтобы воспроизвести результат - добавляем массив и скрипты в одну директорию и запускаем pipeline.py

Описание работы алгоритма find_PnL.py:
1. (line 27) Сортируем датасет по времени, используя функцию parse_ts() (l. 13), которая конвертирует строку из датасета в дейттайм который можно сортировать. 
2. (l. 29) Открываем пустой словарь, и итерируем по строкам датасета. 
    2.1. Если инструмент новый - добавляем его в словарь (l. 35). Затем циклы сводятся к тому чтобы добавить полученную строку в лонг лот (l. 46) или шорт лот (l. 59).
    2.2. Если для инструмента уже есть ключ в словаре - мы мэтчим заявку с существующими лотами (шорт лоты если получили заявку на покупку (l. 34) и лонг лоты если получили заявку на продажу (l. 47)). Когда происходит мэтчинг - мы формируем PnL операций по инструменту который копится в словаре (l. 39 & 52). Если мы закрываем лонг и текущая цена ниже цены покупки лота - ПнЛ снизится, если выше - вырастет. Наоборот для шорта. 
    ** В каждый момент времени в словаре хранятся или только лонг лоты или только шорт лоты. Возможно это можно было сократить или сделать проще, но для меня такой ход решения показался самым естественным.**
    Если лотов нет - заявка из строки просто формирует новый лот (l. 46 & 59).
3. Когда все строки обработаны - начинаем считать PnL в позициях которые ещё держатся (l. 68). Очень легкий процесс - для лонг лотов мы идем по каждому лоту и умножаем объем на разницу между текущей ценой и цену покупки (l. 70), для шорт лотов - на разницу между ценой продажи и текущей ценой (l. 72). Чтобы получить общий ПнЛ, мы складываем realized и unrealized quotes, и делим их на последнюю цену (l. 74,75,76). Так как мы покупаем и продаем доллары, единица измерения нашей позиции будет считаться в той валюте на которую доллар был куплен. Поэтому чтобы конвертировать ПнЛ в USD - нам нужно разделить итоговую сумму на курс.
